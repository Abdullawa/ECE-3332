<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracker</title>
    <!-- Leaflet CSS and JS go HERE in the head -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>                                            
    <h2>Tracking the latest position and history</h2>
    <p>
    <a id="googleMapsLink" href="#" target="_blank">View current location in Google Maps</a>
</p>
    
    <!-- Map container div goes HERE in the body -->
    <div id="map" style="width: 100%; height: 600px;"></div>
    
    <!-- JavaScript code goes HERE at the bottom of body, before closing </body> tag -->
    <script>
        // All your map creation and update code goes here
        var map = L.map('map').setView([33.587, -101.875], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
        
        var marker = L.marker([33.587, -101.875]).addTo(map);

        var pathline = L.polyline([],{
            color: 'blue',
            weight: 3
        }).addTo(map);

        function loadHistory() {
    fetch('/api/history')
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                var coords = data.map(point => [point.latitude, point.longitude]);
                pathline.setLatLngs(coords);
                var lastPoint = coords[coords.length - 1];
                marker.setLatLng(lastPoint);
                map.fitBounds(pathline.getBounds());
                
                // Update Google Maps link
                var lat = lastPoint[0];
                var lng = lastPoint[1];
                var googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                document.getElementById('googleMapsLink').href = googleMapsUrl;
                
                console.log('Loaded', data.length,"points of history");
            }
        })
        .catch(error => {
            console.error('Error fetching history:', error);
        });
}
        
        function updatePosition() {
    fetch('/api/position')
        .then(response => response.json())
        .then(data => {
            loadHistory();  // This updates everything
            console.log('Updated position:', data);
        })
        .catch(error => {
            console.error('Error fetching position:', error);
        });
}
        
        loadHistory();
        setInterval(updatePosition, 2000);
        updatePosition();
    </script>
</body>
</html>